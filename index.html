<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MiniTube — แอพวิดีโอแนวยูทูบ (ไฟล์เดียว)</title>
  <style>
    :root {
      --bg:#0f0f0f; --card:#1a1a1a; --muted:#a0a0a0; --text:#f3f3f3; --accent:#ff3b3b; --accent2:#2ea043;
      --border:#2a2a2a; --warn:#f59e0b;
    }
    * { box-sizing:border-box }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Arial; }
    a { color:inherit; text-decoration:none }
    header {
      position:sticky; top:0; z-index:10; background:#121212; border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:10px; padding:10px 12px;
    }
    header .logo { font-weight:700; letter-spacing:.3px }
    header input[type="search"] {
      flex:1; max-width:560px; background:var(--card); border:1px solid var(--border);
      color:var(--text); padding:8px 10px; border-radius:6px;
    }
    header .actions { display:flex; gap:8px; align-items:center }
    button, .btn {
      background:#262626; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px 12px; cursor:pointer;
    }
    button.primary { background:var(--accent); border-color:#7a1f1f }
    button.green { background:var(--accent2); border-color:#1e7a36 }
    button.secondary { background:#1f2937 }
    button:disabled { opacity:.6; cursor:not-allowed }
    main { padding:14px; max-width:1200px; margin:0 auto }
    nav.tabs { display:flex; gap:8px; margin:12px 0 16px; flex-wrap:wrap }
    nav.tabs .tab { padding:8px 12px; border:1px solid var(--border); border-radius:20px; cursor:pointer; }
    nav.tabs .tab.active { background:#2b2b2b; border-color:#555 }
    .grid { display:grid; grid-template-columns:repeat(4,1fr); gap:14px }
    @media (max-width:1100px) { .grid { grid-template-columns:repeat(3,1fr) } }
    @media (max-width:800px) { .grid { grid-template-columns:repeat(2,1fr) } }
    @media (max-width:520px) { .grid { grid-template-columns:1fr } }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:10px; overflow:hidden;
    }
    .thumb { aspect-ratio:16/9; background:#111; display:block; width:100%; object-fit:cover }
    .card .content { padding:10px }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .muted { color:var(--muted); font-size:.92em }
    .small { font-size:.9em }
    .section { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px; margin:12px 0 }
    label { display:block; margin:8px 0 4px }
    input[type="text"], textarea, select {
      width:100%; background:#121212; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:8px 10px;
    }
    textarea { min-height:90px; resize:vertical }
    .video-player { width:100%; background:#000; border-radius:8px }
    .flex { display:flex; gap:12px; flex-wrap:wrap }
    .left { flex:1 1 680px }
    .right { flex:1 1 360px }
    .pill { display:inline-block; padding:4px 10px; border:1px solid var(--border); border-radius:999px; background:#222; }
    .danger { color:#ff6b6b }
    .divider { height:1px; background:var(--border); margin:10px 0 }
    .empty { color:#bbb; text-align:center; padding:24px }
    .footer { color:#888; text-align:center; padding:16px 0; font-size:.9em }
    .warning { background:#1f1a0b; border:1px solid #5a4420; color:#f2d29b; padding:8px 10px; border-radius:8px }
  </style>
</head>
<body>
<header>
  <div class="logo">MiniTube</div>
  <input id="searchInput" type="search" placeholder="ค้นหาวิดีโอหรือคำอธิบาย..." />
  <div class="actions">
    <button id="uploadBtn" class="green">อัปโหลด</button>
    <button id="myChannelBtn" class="secondary">โปรไฟล์/ช่องของฉัน</button>
  </div>
</header>

<main>
  <nav class="tabs">
    <div class="tab active" data-tab="feed">ฟีด</div>
    <div class="tab" data-tab="explore">สำรวจ</div>
    <div class="tab" data-tab="subscriptions">ที่ติดตาม</div>
  </nav>

  <section id="feedView"></section>
  <section id="exploreView" style="display:none"></section>
  <section id="subscriptionsView" style="display:none"></section>

  <section id="videoView" style="display:none"></section>
  <section id="channelView" style="display:none"></section>
  <section id="profileView" style="display:none"></section>
  <section id="uploadView" style="display:none"></section>
</main>

<div class="footer">สร้างด้วย IndexedDB + LocalStorage | ไฟล์เดียว | บันทึกข้อมูลบนเครื่องของคุณ</div>

<script>
/* ========= Utility & State ========= */
const DB_NAME = 'minitube-db';
const DB_VER = 1;
const MAX_FILE_MB = 512; // ป้องกันไฟล์ใหญ่เกิน
const state = {
  user: null, // {id, name}
  db: null,   // IDBDatabase
  currentTab: 'feed',
  searchQuery: '',
  cache: { videos: [], channels: [], comments: [], likes: [], subs: [] },
};

function uuid() {
  return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function formatDate(ts) {
  try { return new Date(ts).toLocaleString(); } catch { return '' }
}

function escapeHtml(s='') {
  return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

function showSection(id) {
  for (const el of document.querySelectorAll('main > section')) el.style.display = 'none';
  document.getElementById(id).style.display = 'block';
}

function setActiveTab(tab) {
  state.currentTab = tab;
  for (const t of document.querySelectorAll('.tabs .tab')) t.classList.toggle('active', t.dataset.tab===tab);
}

/* ========= IndexedDB Setup ========= */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e) => {
      const db = req.result;
      // videos: {id, title, desc, channelId, createdAt, blob, thumbBlob, likesCount}
      if (!db.objectStoreNames.contains('videos')) {
        const s = db.createObjectStore('videos', { keyPath: 'id' });
        s.createIndex('channelId', 'channelId', { unique:false });
        s.createIndex('createdAt', 'createdAt', { unique:false });
        s.createIndex('title', 'title', { unique:false });
      }
      // channels: {id, ownerId, name, desc, createdAt}
      if (!db.objectStoreNames.contains('channels')) {
        const s = db.createObjectStore('channels', { keyPath: 'id' });
        s.createIndex('ownerId', 'ownerId', { unique:false });
      }
      // comments: {id, videoId, userId, userName, text, createdAt}
      if (!db.objectStoreNames.contains('comments')) {
        const s = db.createObjectStore('comments', { keyPath: 'id' });
        s.createIndex('videoId', 'videoId', { unique:false });
        s.createIndex('createdAt', 'createdAt', { unique:false });
      }
      // likes: {id, videoId, userId}
      if (!db.objectStoreNames.contains('likes')) {
        const s = db.createObjectStore('likes', { keyPath: 'id' });
        s.createIndex('videoId_userId', ['videoId','userId'], { unique:true });
      }
      // subs: {id, channelId, userId}
      if (!db.objectStoreNames.contains('subs')) {
        const s = db.createObjectStore('subs', { keyPath: 'id' });
        s.createIndex('channelId_userId', ['channelId','userId'], { unique:true });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function tx(storeNames, mode='readonly') {
  const t = state.db.transaction(storeNames, mode);
  const stores = storeNames.map(n => t.objectStore(n));
  return { t, stores };
}

async function getAll(storeName) {
  return new Promise((resolve, reject) => {
    const { t, stores:[s] } = tx([storeName]);
    const req = s.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

async function put(storeName, obj) {
  return new Promise((resolve, reject) => {
    const { t, stores:[s] } = tx([storeName], 'readwrite');
    const req = s.put(obj);
    req.onsuccess = () => resolve(obj);
    req.onerror = () => reject(req.error);
  });
}

async function del(storeName, key) {
  return new Promise((resolve, reject) => {
    const { t, stores:[s] } = tx([storeName], 'readwrite');
    const req = s.delete(key);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

async function indexQuery(storeName, indexName, keyRange=null, direction='prev') {
  return new Promise((resolve, reject) => {
    const { t, stores:[s] } = tx([storeName]);
    const idx = s.index(indexName);
    const req = idx.openCursor(keyRange, direction);
    const res = [];
    req.onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) { res.push(cursor.value); cursor.continue(); }
      else resolve(res);
    };
    req.onerror = () => reject(req.error);
  });
}

/* ========= Auth / User ========= */
function loadUser() {
  try {
    const raw = localStorage.getItem('minitube-user');
    if (raw) state.user = JSON.parse(raw);
  } catch {}
  if (!state.user) {
    const name = prompt('ตั้งชื่อผู้ใช้ของคุณ (แก้ไขได้ภายหลัง):') || '';
    const safe = name.trim() || 'ผู้ใช้-' + Math.random().toString(36).slice(2,6);
    state.user = { id: uuid(), name: safe };
    localStorage.setItem('minitube-user', JSON.stringify(state.user));
  }
}

function saveUser(u) {
  state.user = u;
  localStorage.setItem('minitube-user', JSON.stringify(state.user));
}

/* ========= Channels ========= */
async function getMyChannel() {
  const all = await getAll('channels');
  return all.find(c => c.ownerId === state.user.id) || null;
}

async function ensureMyChannel() {
  let ch = await getMyChannel();
  if (!ch) {
    ch = { id: uuid(), ownerId: state.user.id, name: `${state.user.name} Channel`, desc: 'ยินดีต้อนรับสู่ช่องของฉัน!', createdAt: Date.now() };
    await put('channels', ch);
  }
  return ch;
}

async function getChannelById(id) {
  const all = await getAll('channels');
  return all.find(c => c.id === id) || null;
}

/* ========= Videos ========= */
async function addVideo({ file, title, desc, channelId }) {
  if (!file) throw new Error('ไม่ได้เลือกไฟล์วิดีโอ');
  const mb = (file.size || 0) / (1024*1024);
  if (mb > MAX_FILE_MB) throw new Error(`ไฟล์ใหญ่เกิน ${MAX_FILE_MB} MB`);

  // สร้าง thumbnail จากเฟรมแรกของวิดีโอ
  const thumbBlob = await generateThumbnail(file).catch(() => null);
  const v = {
    id: uuid(),
    title: title?.trim() || file.name || 'Untitled',
    desc: desc?.trim() || '',
    channelId,
    createdAt: Date.now(),
    blob: file, // เก็บ blob ตรงๆใน IndexedDB
    thumbBlob,
    likesCount: 0
  };
  await put('videos', v);
  return v;
}

async function generateThumbnail(file) {
  return new Promise((resolve, reject) => {
    try {
      const url = URL.createObjectURL(file);
      const vid = document.createElement('video');
      vid.preload = 'metadata';
      vid.src = url;
      vid.muted = true;
      vid.playsInline = true;
      vid.onloadeddata = async () => {
        try {
          vid.currentTime = Math.min(0.1, vid.duration || 0);
          await vid.play().catch(()=>{});
          const canvas = document.createElement('canvas');
          const w = 640, h = Math.round(w * 9/16);
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(vid, 0, 0, w, h);
          canvas.toBlob(b => {
            URL.revokeObjectURL(url);
            b ? resolve(b) : reject(new Error('สร้างภาพปกไม่สำเร็จ'));
          }, 'image/jpeg', 0.8);
        } catch (e) { URL.revokeObjectURL(url); reject(e); }
      };
      vid.onerror = () => { URL.revokeObjectURL(url); reject(new Error('อ่านวิดีโอไม่ได้')) };
    } catch (e) { reject(e) }
  });
}

async function listRecentVideos(limit=50) {
  const arr = await indexQuery('videos', 'createdAt', null, 'prev');
  return arr.slice(0, limit);
}

function blobUrl(blob) {
  try { return blob ? URL.createObjectURL(blob) : ''; } catch { return '' }
}

/* ========= Likes ========= */
async function toggleLike(videoId) {
  const key = [videoId, state.user.id];
  const likes = await getAll('likes');
  const existing = likes.find(l => l.videoId === videoId && l.userId === state.user.id);
  if (existing) {
    await del('likes', existing.id);
  } else {
    await put('likes', { id: uuid(), videoId, userId: state.user.id });
  }
  // sync likesCount
  const vids = await getAll('videos');
  const v = vids.find(x => x.id === videoId);
  if (v) {
    const count = (await getAll('likes')).filter(l => l.videoId === videoId).length;
    v.likesCount = count;
    await put('videos', v);
  }
}

/* ========= Comments ========= */
async function addComment(videoId, text) {
  const t = text?.trim();
  if (!t) throw new Error('คอมเมนต์ว่างเปล่า');
  const c = { id: uuid(), videoId, userId: state.user.id, userName: state.user.name, text: t, createdAt: Date.now() };
  await put('comments', c);
  return c;
}
async function listComments(videoId) {
  const all = await indexQuery('comments', 'createdAt', null, 'prev');
  return all.filter(c => c.videoId === videoId);
}

/* ========= Subscriptions ========= */
async function toggleSub(channelId) {
  const all = await getAll('subs');
  const ex = all.find(s => s.channelId === channelId && s.userId === state.user.id);
  if (ex) await del('subs', ex.id);
  else await put('subs', { id: uuid(), channelId, userId: state.user.id });
}
async function listMySubs() {
  const all = await getAll('subs');
  return all.filter(s => s.userId === state.user.id).map(s => s.channelId);
}

/* ========= Rendering ========= */
function renderCards(videos) {
  const div = document.createElement('div');
  div.className = 'grid';
  if (!videos.length) {
    const e = document.createElement('div');
    e.className = 'empty';
    e.textContent = 'ยังไม่มีวิดีโอ';
    return e;
  }
  for (const v of videos) {
    const card = document.createElement('div');
    card.className = 'card';
    const imgUrl = blobUrl(v.thumbBlob);
    const videoUrl = blobUrl(v.blob);
    const img = document.createElement(imgUrl ? 'img' : 'div');
    if (imgUrl) { img.src = imgUrl; img.className='thumb'; }
    else { img.className='thumb'; }
    img.onclick = () => openVideo(v.id);
    const c = document.createElement('div'); c.className = 'content';
    c.innerHTML = `
      <div class="row">
        <div style="font-weight:600; flex:1">${escapeHtml(v.title)}</div>
        <div class="pill small">${v.likesCount||0} ไลก์</div>
      </div>
      <div class="muted small">${formatDate(v.createdAt)}</div>
    `;
    card.appendChild(img);
    card.appendChild(c);
    div.appendChild(card);
  }
  return div;
}

async function openVideo(videoId) {
  try {
    const vids = await getAll('videos');
    const v = vids.find(x => x.id === videoId);
    if (!v) return alert('ไม่พบวิดีโอนี้');
    const ch = await getChannelById(v.channelId);
    const comments = await listComments(videoId);
    showSection('videoView');
    const el = document.getElementById('videoView');
    el.innerHTML = '';
    const wrap = document.createElement('div'); wrap.className='flex';
    const left = document.createElement('div'); left.className='left section';
    const right = document.createElement('div'); right.className='right section';

    const url = blobUrl(v.blob);
    const player = document.createElement('video');
    player.controls = true; player.className='video-player'; player.src = url;
    left.appendChild(player);

    const title = document.createElement('h2'); title.textContent = v.title;
    left.appendChild(title);

    const row = document.createElement('div'); row.className='row';
    const likeBtn = document.createElement('button'); likeBtn.textContent='ไลก์';
    likeBtn.onclick = async () => { await toggleLike(v.id); openVideo(v.id); };
    const likeCount = document.createElement('div'); likeCount.className='pill'; likeCount.textContent = `${v.likesCount||0} ไลก์`;
    const channelLink = document.createElement('button'); channelLink.className='secondary'; channelLink.textContent = ch ? `ไปที่ช่อง: ${ch.name}` : 'ช่องไม่พบ';
    channelLink.onclick = () => openChannel(v.channelId);
    row.appendChild(likeBtn); row.appendChild(likeCount); row.appendChild(channelLink);
    left.appendChild(row);

    const desc = document.createElement('div'); desc.className='muted'; desc.textContent = v.desc || '';
    left.appendChild(desc);

    // Comments
    const cTitle = document.createElement('h3'); cTitle.textContent = 'คอมเมนต์';
    left.appendChild(cTitle);
    const form = document.createElement('div');
    form.innerHTML = `
      <label>พิมพ์คอมเมนต์ของคุณ</label>
      <textarea id="commentText"></textarea>
      <div class="row"><button id="sendComment" class="green">ส่งคอมเมนต์</button></div>
      <div class="divider"></div>
    `;
    left.appendChild(form);
    form.querySelector('#sendComment').onclick = async () => {
      try {
        const text = form.querySelector('#commentText').value;
        await addComment(v.id, text);
        openVideo(v.id);
      } catch (e) { alert(e.message || 'ส่งคอมเมนต์ผิดพลาด'); }
    };

    if (!comments.length) {
      const em = document.createElement('div'); em.className='empty'; em.textContent='ยังไม่มีคอมเมนต์';
      left.appendChild(em);
    } else {
      for (const c of comments) {
        const item = document.createElement('div'); item.className='section';
        item.innerHTML = `
          <div style="font-weight:600">${escapeHtml(c.userName)}</div>
          <div class="muted small">${formatDate(c.createdAt)}</div>
          <div style="margin-top:6px">${escapeHtml(c.text)}</div>
        `;
        left.appendChild(item);
      }
    }

    // Right column: Channel info
    const chBox = document.createElement('div');
    chBox.innerHTML = `
      <h3>ช่อง</h3>
      <div><strong>${escapeHtml(ch?.name || 'ช่องไม่พบ')}</strong></div>
      <div class="muted small" style="margin-top:6px">${escapeHtml(ch?.desc || '')}</div>
      <div class="row" style="margin-top:10px">
        <button id="subBtn">${await isSubbed(ch?.id) ? 'เลิกติดตาม' : 'ติดตาม'}</button>
      </div>
    `;
    right.appendChild(chBox);
    right.querySelector('#subBtn').onclick = async () => { await toggleSub(ch.id); openVideo(v.id) };

    wrap.appendChild(left); wrap.appendChild(right);
    el.appendChild(wrap);
  } catch (e) {
    alert(e.message || 'เปิดวิดีโอผิดพลาด');
  }
}

async function isSubbed(channelId) {
  const subs = await listMySubs();
  return subs.includes(channelId);
}

async function openChannel(channelId) {
  try {
    const ch = await getChannelById(channelId);
    if (!ch) return alert('ไม่พบช่องนี้');
    showSection('channelView');
    const el = document.getElementById('channelView');
    el.innerHTML = '';
    const box = document.createElement('div'); box.className='section';
    box.innerHTML = `
      <h2>${escapeHtml(ch.name)}</h2>
      <div class="muted">${escapeHtml(ch.desc)}</div>
      <div class="row" style="margin-top:10px">
        <button id="subBtn">${await isSubbed(ch.id) ? 'เลิกติดตาม' : 'ติดตาม'}</button>
        ${ch.ownerId===state.user.id ? '<button id="editCh" class="secondary">แก้ไขช่อง</button>' : ''}
      </div>
    `;
    el.appendChild(box);
    box.querySelector('#subBtn').onclick = async () => { await toggleSub(ch.id); openChannel(ch.id); };

    if (ch.ownerId===state.user.id) {
      box.querySelector('#editCh').onclick = async () => {
        const name = prompt('ชื่อช่องใหม่', ch.name) || ch.name;
        const desc = prompt('คำอธิบายช่องใหม่', ch.desc) || ch.desc;
        ch.name = name.trim() || ch.name;
        ch.desc = desc.trim() || ch.desc;
        await put('channels', ch);
        openChannel(ch.id);
      };
    }

    const vids = (await listRecentVideos(200)).filter(v => v.channelId === ch.id);
    el.appendChild(renderCards(vids));
  } catch (e) { alert(e.message || 'เปิดช่องผิดพลาด'); }
}

/* ========= Views ========= */
async function renderFeed() {
  showSection('feedView'); setActiveTab('feed');
  const subs = await listMySubs();
  const vids = await listRecentVideos(100);
  const feed = vids.filter(v => subs.includes(v.channelId));
  const el = document.getElementById('feedView');
  el.innerHTML = '<h2>ฟีด</h2>';
  el.appendChild(renderCards(feed));
}

async function renderExplore() {
  showSection('exploreView'); setActiveTab('explore');
  const vids = await listRecentVideos(100);
  const el = document.getElementById('exploreView');
  el.innerHTML = '<h2>สำรวจ</h2>';
  el.appendChild(renderCards(vids));
}

async function renderSubs() {
  showSection('subscriptionsView'); setActiveTab('subscriptions');
  const subs = await listMySubs();
  const channels = await getAll('channels');
  const my = channels.filter(c => subs.includes(c.id));
  const el = document.getElementById('subscriptionsView');
  el.innerHTML = '<h2>ช่องที่ติดตาม</h2>';
  if (!my.length) {
    const em = document.createElement('div'); em.className='empty'; em.textContent='ยังไม่ได้ติดตามช่องใด';
    el.appendChild(em); return;
  }
  const wrap = document.createElement('div'); wrap.className='grid';
  for (const c of my) {
    const card = document.createElement('div'); card.className='card';
    const content = document.createElement('div'); content.className='content';
    content.innerHTML = `
      <div style="font-weight:600">${escapeHtml(c.name)}</div>
      <div class="muted small">${escapeHtml(c.desc)}</div>
      <div class="row" style="margin-top:8px">
        <button class="secondary">เปิดช่อง</button>
        <button>${await isSubbed(c.id) ? 'เลิกติดตาม' : 'ติดตาม'}</button>
      </div>
    `;
    const btns = content.querySelectorAll('button');
    btns[0].onclick = () => openChannel(c.id);
    btns[1].onclick = async () => { await toggleSub(c.id); renderSubs(); };
    card.appendChild(content);
    wrap.appendChild(card);
  }
  el.appendChild(wrap);
}

async function renderProfile() {
  showSection('profileView');
  const el = document.getElementById('profileView');
  el.innerHTML = '<h2>โปรไฟล์/ช่องของฉัน</h2>';
  const box = document.createElement('div'); box.className='section';
  const ch = await ensureMyChannel();
  box.innerHTML = `
    <div class="row">
      <div><strong>ผู้ใช้:</strong> ${escapeHtml(state.user.name)}</div>
      <button id="renameUser" class="secondary">แก้ไขชื่อผู้ใช้</button>
    </div>
    <div class="divider"></div>
    <h3>ช่องของฉัน</h3>
    <label>ชื่อช่อง</label>
    <input id="chName" type="text" value="${escapeHtml(ch.name)}"/>
    <label>คำอธิบายช่อง</label>
    <textarea id="chDesc">${escapeHtml(ch.desc)}</textarea>
    <div class="row" style="margin-top:8px">
      <button id="saveCh" class="green">บันทึก</button>
      <button id="openCh" class="secondary">เปิดช่อง</button>
    </div>
    <div class="warning" style="margin-top:10px">ข้อมูลทั้งหมดถูกเก็บบนเครื่องของคุณ หากลบแคช/IndexedDB ข้อมูลจะหาย</div>
  `;
  el.appendChild(box);
  box.querySelector('#renameUser').onclick = () => {
    const name = prompt('ชื่อผู้ใช้ใหม่', state.user.name) || state.user.name;
    saveUser({ ...state.user, name: name.trim() || state.user.name });
    renderProfile();
  };
  box.querySelector('#saveCh').onclick = async () => {
    ch.name = document.getElementById('chName').value.trim() || ch.name;
    ch.desc = document.getElementById('chDesc').value.trim() || ch.desc;
    await put('channels', ch);
    alert('บันทึกช่องเรียบร้อย');
  };
  box.querySelector('#openCh').onclick = () => openChannel(ch.id);

  // My videos
  const vids = (await listRecentVideos(200)).filter(v => v.channelId === ch.id);
  const sec = document.createElement('div'); sec.className='section';
  const count = vids.length;
  sec.innerHTML = `<h3>วิดีโอของฉัน (${count})</h3>`;
  sec.appendChild(renderCards(vids));
  el.appendChild(sec);
}

function renderUpload() {
  showSection('uploadView');
  const el = document.getElementById('uploadView');
  el.innerHTML = `
    <h2>อัปโหลดวิดีโอ</h2>
    <div class="section">
      <label>ไฟล์วิดีโอ (MP4/WebM)</label>
      <input id="fileInput" type="file" accept="video/mp4,video/webm"/>
      <label>ชื่อวิดีโอ</label>
      <input id="vidTitle" type="text" placeholder="ตั้งชื่อคลิป..."/>
      <label>คำอธิบาย</label>
      <textarea id="vidDesc" placeholder="เพิ่มรายละเอียด..."></textarea>
      <div class="row" style="margin-top:8px">
        <button id="doUpload" class="green">อัปโหลด</button>
        <span class="muted small">สูงสุด ~${MAX_FILE_MB} MB</span>
      </div>
    </div>
  `;
  document.getElementById('doUpload').onclick = async () => {
    try {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert('กรุณาเลือกไฟล์วิดีโอ');
      const title = document.getElementById('vidTitle').value;
      const desc = document.getElementById('vidDesc').value;
      const ch = await ensureMyChannel();
      const v = await addVideo({ file, title, desc, channelId: ch.id });
      alert('อัปโหลดสำเร็จ');
      openVideo(v.id);
    } catch (e) { alert(e.message || 'อัปโหลดผิดพลาด'); }
  };
}

/* ========= Search ========= */
async function doSearch(query) {
  state.searchQuery = query;
  const vids = await listRecentVideos(300);
  const q = (query||'').toLowerCase();
  const filtered = vids.filter(v =>
    v.title?.toLowerCase().includes(q) || v.desc?.toLowerCase().includes(q)
  );
  showSection('exploreView'); setActiveTab('explore');
  const el = document.getElementById('exploreView');
  el.innerHTML = `<h2>ผลการค้นหา: "${escapeHtml(query)}"</h2>`;
  el.appendChild(renderCards(filtered));
}

/* ========= Event Binding ========= */
function bindUI() {
  document.querySelectorAll('.tabs .tab').forEach(tab => {
    tab.onclick = async () => {
      const t = tab.dataset.tab;
      if (t==='feed') await renderFeed();
      else if (t==='explore') await renderExplore();
      else if (t==='subscriptions') await renderSubs();
    };
  });
  document.getElementById('uploadBtn').onclick = () => renderUpload();
  document.getElementById('myChannelBtn').onclick = () => renderProfile();
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') doSearch(e.target.value);
  });
}

/* ========= Boot ========= */
(async function boot(){
  try {
    loadUser();
    state.db = await openDB();
    bindUI();
    await ensureMyChannel(); // ให้มีช่องเริ่มต้นเสมอ
    await renderFeed();      // เริ่มที่ฟีด
  } catch (e) {
    console.error(e);
    const root = document.querySelector('main');
    root.innerHTML = `
      <div class="section danger">
        เกิดข้อผิดพลาดในการเริ่มระบบ: ${escapeHtml(e.message||'')}
      </div>
    `;
  }
})();
</script>
</body>
</html>